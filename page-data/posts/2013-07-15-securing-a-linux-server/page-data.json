{"componentChunkName":"component---src-templates-blog-post-index-jsx","path":"/posts/2013-07-15-securing-a-linux-server/","result":{"data":{"mdx":{"id":"20a15d15-c9ce-521d-a257-03fbefb8677c","fields":{"slug":"/posts/2013-07-15-securing-a-linux-server/","date":"2013-07-15T10:52-07:00","lastModified":"2013-07-15T10:52-07:00","author":"Spenser Jones"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Securing a Linux Server\",\n  \"author\": \"Spenser Jones\",\n  \"tags\": [\"Server Administration\", \"Security\"],\n  \"date\": \"2013-07-15T10:52-07:00\",\n  \"redirect_from\": [\"/blog/2013/07/15/securing-a-linux-server/\"],\n  \"published\": true\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"It is a rarity to watch someone secure a freshly installed server right off the bat, yet the world we live in makes this a necessity. So why do so many people put it off until the end, if at all? I've done the exact same thing, and it often comes down to wanting to get right into the fun stuff. Hopefully this post will show that it is far easier than you think to secure a server, and can be quite entertaining to look down from your fortress, when the attacks begin to flow.\"), mdx(\"p\", null, \"This post is written for Ubuntu 12.04.2 LTS, however you can do similar things on any other Linux distribution.\"), mdx(\"h2\", null, \"Where do I begin?\"), mdx(\"p\", null, \"If this server already has a public IP, you'll want to lock down root access immediately. In fact, you'll want to lock down SSH access entirely, and make sure that only \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"you\"), \" can get in. Add a new user, and add it to an admin group (preconfigured in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/sudoers\"), \" to have access to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"sudo\"), \").\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ sudo addgroup admin\\nAdding group 'admin' (GID 1001)\\nDone.\\n\\n$ sudo adduser spenserj\\nAdding user `spenserj' ...\\nAdding new group `spenserj' (1002) ...\\nAdding new user `spenserj' (1001) with group `spenserj' ...\\nCreating home directory `/home/spenserj' ...\\nCopying files from `/etc/skel' ...\\nEnter new UNIX password:\\nRetype new UNIX password:\\npasswd: password updated successfully\\nChanging the user information for spenserj\\nEnter the new value, or press ENTER for the default\\n    Full Name []: Spenser Jones\\n    Room Number []:\\n    Work Phone []:\\n    Home Phone []:\\n    Other []:\\nIs the information correct? [Y/n] y\\n\\n$ sudo usermod -a -G admin spenserj\\n\")), mdx(\"p\", null, \"You\\u2019ll also want to create a private key on your computer, and disable that pesky password authentication on the server.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ mkdir ~/.ssh\\n$ echo \\\"ssh-rsa [your public key]\\\" > ~/.ssh/authorized_keys\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"/etc/ssh/sshd_config\",\n    \"/etc/ssh/sshd_config\": true\n  }), \"PermitRootLogin no\\nPermitEmptyPasswords no\\nPasswordAuthentication no\\nAllowUsers spenserj\\n\")), mdx(\"p\", null, \"Reload SSH to apply the changes, and then try logging in \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"in a new session\"), \" to ensure everything worked. If you can't log in, you'll still have your original session to fix things up.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ sudo service ssh restart\\nssh stop/waiting\\nssh start/running, process 1599\\n\")), mdx(\"h2\", null, \"Update the server\"), mdx(\"p\", null, \"Now that you're the only one with access to the server, you can stop worrying about a hacker sneaking in, and breathe normally again. Chances are good that there are some updates for your server, so go ahead and run those now.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ sudo apt-get update\\n...\\nHit http://ca.archive.ubuntu.com precise-updates/universe Translation-en_CA\\nHit http://ca.archive.ubuntu.com precise-updates/universe Translation-en\\nHit http://ca.archive.ubuntu.com precise-backports/main Translation-en\\nHit http://ca.archive.ubuntu.com precise-backports/multiverse Translation-en\\nHit http://ca.archive.ubuntu.com precise-backports/restricted Translation-en\\nHit http://ca.archive.ubuntu.com precise-backports/universe Translation-en\\nFetched 3,285 kB in 5s (573 kB/s)\\nReading package lists... Done\\n\\n$ sudo apt-get upgrade\\nReading package lists... Done\\nBuilding dependency tree\\nReading state information... Done\\nThe following packages have been kept back:\\n  linux-headers-generic-lts-quantal linux-image-generic-lts-quantal\\nThe following packages will be upgraded:\\n  accountsservice apport apt apt-transport-https apt-utils aptitude bash ...\\n73 upgraded, 0 newly installed, 0 to remove and 2 not upgraded.\\nNeed to get 61.0 MB of archives.\\nAfter this operation, 151 kB of additional disk space will be used.\\nDo you want to continue [Y/n]? Y\\n...\\nSetting up libisc83 (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up libdns81 (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up libisccc80 (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up libisccfg82 (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up libbind9-80 (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up liblwres80 (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up bind9-host (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up dnsutils (1:9.8.1.dfsg.P1-4ubuntu0.6) ...\\nSetting up iptables (1.4.12-1ubuntu5) ...\\n...\\n\")), mdx(\"h2\", null, \"Install a Firewall\"), mdx(\"p\", null, \"Running the most recent software now? Good. Go ahead and set up a firewall, and \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"only\"), \" allow what you need right at this moment. You can always add another exception later, and a few minutes of extra work won't kill you. IPTables comes preinstalled in Ubuntu, so go ahead and set up some rules for it.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ sudo mkdir /etc/iptables\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"/etc/iptables/rules\",\n    \"/etc/iptables/rules\": true\n  }), \"*filter\\n:INPUT DROP [0:0]\\n:FORWARD DROP [0:0]\\n:OUTPUT DROP [0:0]\\n\\n# Accept any related or established connections\\n-I INPUT  1 -m state --state RELATED,ESTABLISHED -j ACCEPT\\n-I OUTPUT 1 -m state --state RELATED,ESTABLISHED -j ACCEPT\\n\\n# Allow all traffic on the loopback interface\\n-A INPUT  -i lo -j ACCEPT\\n-A OUTPUT -o lo -j ACCEPT\\n\\n# Allow outbound DHCP request - Some hosts (Linode) automatically assign the primary IP\\n#-A OUTPUT -p udp --dport 67:68 --sport 67:68 -j ACCEPT\\n\\n# Outbound DNS lookups\\n-A OUTPUT -o eth0 -p udp -m udp --dport 53 -j ACCEPT\\n\\n# Outbound PING requests\\n-A OUTPUT -p icmp -j ACCEPT\\n\\n# Outbound Network Time Protocol (NTP) request\\n-A OUTPUT -p udp --dport 123 --sport 123 -j ACCEPT\\n\\n# SSH\\n-A INPUT  -i eth0 -p tcp -m tcp --dport 22 -m state --state NEW -j ACCEPT\\n\\n# Outbound HTTP\\n-A OUTPUT -o eth0 -p tcp -m tcp --dport 80 -m state --state NEW -j ACCEPT\\n-A OUTPUT -o eth0 -p tcp -m tcp --dport 443 -m state --state NEW -j ACCEPT\\n\\nCOMMIT\\n\")), mdx(\"p\", null, \"Apply the ruleset with a timeout through \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"iptables-apply\"), \", and if you lose the connection, fix your rules and try again before continuing.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ sudo iptables-apply /etc/iptables/rules\\nApplying new ruleset... done.\\nCan you establish NEW connections to the machine? (y/N) y\\n... then my job is done. See you next time.\\n\")), mdx(\"p\", null, \"Create the file \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/network/if-pre-up.d/iptables\"), \", with the following content. This will automatically load your IPTables rules when you start the server.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"/etc/network/if-pre-up.d/iptables\",\n    \"/etc/network/if-pre-up.d/iptables\": true\n  }), \"#!/bin/sh\\niptables-restore < /etc/iptables/rules\\n\")), mdx(\"p\", null, \"Now give it execute permissions, and execute the file to ensure it loads properly.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ sudo chmod +x /etc/network/if-pre-up.d/iptables\\n$ sudo /etc/network/if-pre-up.d/iptables\\n\")), mdx(\"h2\", null, \"Fail2ban those wannabe-hackers\"), mdx(\"p\", null, \"Fail2ban is one of my favourite tools when it comes to security, as it will monitor your logfiles, and temporarily ban users that are misusing your resources, be it brute forcing your SSH connection, or DoSing your webserver.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"Install Fail2ban\",\n    \"Install\": true,\n    \"Fail2ban\": true\n  }), \"$ sudo apt-get install fail2ban\\n[sudo] password for sjones:\\nReading package lists... Done\\nBuilding dependency tree\\nReading state information... Done\\nThe following extra packages will be installed:\\n  gamin libgamin0 python-central python-gamin python-support whois\\nSuggested packages:\\n  mailx\\nThe following NEW packages will be installed:\\n  fail2ban gamin libgamin0 python-central python-gamin python-support whois\\n0 upgraded, 7 newly installed, 0 to remove and 2 not upgraded.\\nNeed to get 254 kB of archives.\\nAfter this operation, 1,381 kB of additional disk space will be used.\\nDo you want to continue [Y/n]? y\\n...\\n\")), mdx(\"p\", null, \"Fail2ban installs a default configuration (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/fail2ban/jail.conf\"), \"), but we'll want to make our changes in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/fail2ban/jail.local\"), \", so copy it there.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"sudo cp /etc/fail2ban/jail.{conf,local}\\n\")), mdx(\"h3\", null, \"Configuration\"), mdx(\"p\", null, \"Change the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ignoreip\"), \" line to your IP, and decide on an amount of time to ban the scumbags for (default is 10 minutes). You'll also want to set up a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"destemail\"), \", which I normally enter as my own email address followed by \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \",fail2ban@blocklist.de\"), \". \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://www.blocklist.de/\"\n  }), \"BlockList.de\"), \" is a system to track and automatically report hacking attempts to the proper abuse contact for their IP.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"/etc/fail2ban/jail.local\",\n    \"/etc/fail2ban/jail.local\": true\n  }), \"[DEFAULT]\\n\\n# \\\"ignoreip\\\" can be an IP address, a CIDR mask or a DNS host\\nignoreip = 127.0.0.1/8\\nbantime  = 600\\nmaxretry = 3\\n\\n# \\\"backend\\\" specifies the backend used to get files modification. Available\\n# options are \\\"gamin\\\", \\\"polling\\\" and \\\"auto\\\".\\n# yoh: For some reason Debian shipped python-gamin didn't work as expected\\n#      This issue left ToDo, so polling is default backend for now\\nbackend = auto\\n\\n#\\n# Destination email address used solely for the interpolations in\\n# jail.{conf,local} configuration files.\\ndestemail = root@localhost,fail2ban@blocklist.de\\n\")), mdx(\"p\", null, \"There are a few other settings you'll want to check out, although the defaults are quite sufficient, so skim through the file quickly until you reach the Actions section.\"), mdx(\"h3\", null, \"Actions\"), mdx(\"p\", null, \"Actions allow you to react to malicious activity, however the default is to issue an IPTables ban, while we want it to ban \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"and\"), \" send an email. Thankfully there is a preconfigured \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"action_wml\"), \", which does just that.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"/etc/fail2ban/jail.local\",\n    \"/etc/fail2ban/jail.local\": true\n  }), \"# Choose default action.  To change, just override value of 'action' with the\\n# interpolation to the chosen action shortcut (e.g.  action_mw, action_mwl, etc) in jail.local\\n# globally (section [DEFAULT]) or per specific section\\naction = %(action_mwl)s\\n\")), mdx(\"h3\", null, \"Jails\"), mdx(\"p\", null, \"In order for Fail2ban to work, it needs to know what to watch. These are configured in the Jails section of the config, and there are quite a few examples pre-loaded and disabled. Since you've only enabled SSH access on the server so far, we'll only enable the SSH and SSH-DDoS jails, however you'll want to add a new jail for each publicly-accessible service that you install on this server.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"/etc/fail2ban/jail.local\",\n    \"/etc/fail2ban/jail.local\": true\n  }), \"[ssh]\\n\\nenabled  = true\\nport     = ssh\\nfilter   = sshd\\nlogpath  = /var/log/auth.log\\nmaxretry = 6\\n\\n[ssh-ddos]\\n\\nenabled  = true\\nport     = ssh\\nfilter   = sshd-ddos\\nlogpath  = /var/log/auth.log\\nmaxretry = 6\\n\")), mdx(\"h3\", null, \"Apply the changes\"), mdx(\"p\", null, \"Now that we've configured Fail2ban, you'll want to reload it, and confirm that it is adding the appropriate rules to IPTables.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\"\n  }), \"$ sudo service fail2ban restart\\n * Restarting authentication failure monitor fail2ban\\n   ...done.\\n\\n$ sudo iptables -L\\nChain INPUT (policy DROP)\\ntarget     prot opt source               destination\\nfail2ban-ssh-ddos  tcp  --  anywhere             anywhere             multiport dports ssh\\nfail2ban-ssh  tcp  --  anywhere             anywhere             multiport dports ssh\\n...\\nChain fail2ban-ssh (1 references)\\ntarget     prot opt source               destination\\nRETURN     all  --  anywhere             anywhere\\n\\nChain fail2ban-ssh-ddos (1 references)\\ntarget     prot opt source               destination\\nRETURN     all  --  anywhere             anywhere\\n\")), mdx(\"p\", null, \"At any time, you can use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"sudo iptables -L\"), \" to list your rules, and subsequently list any currently-banned IPs. At the moment, Fail2ban is handling two malicious individuals:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-plain\",\n    \"metastring\": \"Banned IPs\",\n    \"Banned\": true,\n    \"IPs\": true\n  }), \"DROP       all  --  204.50.33.22         anywhere\\nDROP       all  --  195.128.126.114      anywhere\\n\")), mdx(\"h2\", null, \"Staying on top of things\"), mdx(\"p\", null, \"You should now have a server that is locked down and ready to use, however this is not the end of your security journey. Stay on top of updates (and always test them in a non-production environment first), always close ports that you don't need, check your logs regularly, and know your servers inside-and-out.\"), mdx(\"h2\", null, \"HackerNews Followup\"), mdx(\"p\", null, \"There are some great comments over at \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://news.ycombinator.com/item?id=6384603\"\n  }), \"HackerNews\"), \", and I suggest you read through them if you're interested in different perspectives and higher security. This post is intended as a beginners guide to security, and the end of this post does not mean your server is invulnerable. Use this to quickly lock down a new server, and then build upon it for your unique situation. You may want to look into IPV6 security, changing your SSH port (security through obscurity), secured kernels (SELinux and GRSecurity), tracking system changes, and full audits if your server has ever been unsecured, or has been online for any substantial length of time. There are hundreds of entry points into a server, and every application you install brings yet another possible hole, but with the proper tools, you can go to bed without worries.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"It is a rarity to watch someone secure a freshly installed server right off the bat, yet the world we live in makes this a necessity. So why do so…","frontmatter":{"title":"Securing a Linux Server","author":"Spenser Jones","tags":["Server Administration","Security"]}},"site":{"id":"Site","siteMetadata":{"author":"@spenserj"}}},"pageContext":{"slug":"/posts/2013-07-15-securing-a-linux-server/"}}}